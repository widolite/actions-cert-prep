name: Node.js CI

on:
  push: 
    branches: 
     - main
  workflow_dispatch: 

jobs:
  test:
    services:
      webserver:
        image: nginx:latest
        env:
          NGINX_PORT: 8080
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app/
    steps:
      - name: checkout repo.
        uses: actions/checkout@v2

      - name: install dependencies.
        run: npm install
        
      - name: running the app.
        run: npm start &

      - name: run test suite.
        run: npm test

      - name: testing nginx service running as sidecard container.
        run: curl -X GET http://127.0.0.1:8080
  start-server:
    runs-on: ubuntu-latest
    needs: test
    defaults:
      run:
        working-directory: app/
    steps:
      - name: checkout repo
        uses: actions/checkout@v2
      
      - name: install dependencies
        run: npm install

      - name: start server
        run: npm start &
      
      - name: conditional step.
        run: echo "this step only runs on the main branch"
        if: github.ref == 'refs/heads/main'
      
      - name: print the secrets.
        run: echo "SECRET_VALUE_A=${{secrets.SECRET_VALUE_A}}"
      
      - name: conditional secret.
        if: env.SECRET_VALUE == 'A'
        run: echo "SECRET_VALUE_A is equal to A" 
        env:
          SECRET_VALUE: ${{secrets.SECRET_VALUE_A}}